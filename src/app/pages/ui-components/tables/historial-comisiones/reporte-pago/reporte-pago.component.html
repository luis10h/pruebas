<mat-card class="card-reporte">
  <mat-card-title>ðŸ“Š Reporte de Pagos</mat-card-title>
  <mat-card-content>

    <!-- FILTROS -->
    <div class="container-fluid">
      <div class="row g-3">

        <div class="col-md-2 col-sm-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>CÃ©dula</mat-label>
            <input matInput [(ngModel)]="cedulaFiltro" />
          </mat-form-field>
        </div>

        <div class="col-md-2 col-sm-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="estadoFiltro">
              <mat-option value="">Todos</mat-option>
              <mat-option value="pagado">Pagado</mat-option>
              <mat-option value="abonado">Abonado</mat-option>
              <mat-option value="no-pagado">No pagado</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-2 col-sm-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha inicio</mat-label>
            <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" />
            <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-md-2 col-sm-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha fin</mat-label>
            <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" />
            <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
            <mat-datepicker #pickerFin></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- BOTONES -->
        <div class="col-md-2 col-sm-3 d-flex align-items-center" style="gap: 5px;">
          <button mat-raised-button class="btn-azul-personalizado" (click)="cargarReporte()">
            <mat-icon>search</mat-icon><span class="btn-text ms-1">Buscar</span>
          </button>

          <button mat-raised-button class="btn-verde" (click)="exportarExcel()">
            <mat-icon>download</mat-icon><span class="btn-text ms-1">Exportar</span>
          </button>
        </div>

      </div>
    </div>

    <!-- TABLA -->
    <div class="table-container mt-4">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z1">

        <!-- Columnas -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Nombre</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.nombre }}
          </td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.fecha }}
          </td>
        </ng-container>

        <ng-container matColumnDef="cedula">
          <th mat-header-cell *matHeaderCellDef>CÃ©dula</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.cedula }}
          </td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.estado }}
          </td>
        </ng-container>

        <ng-container matColumnDef="total_a_pagar">
          <th mat-header-cell *matHeaderCellDef>Total a pagar</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.total_a_pagar | currency:'COP':'symbol' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="pagado">
          <th mat-header-cell *matHeaderCellDef>Pagado</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.pagado | currency:'COP':'symbol' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="pendiente">
          <th mat-header-cell *matHeaderCellDef>Pendiente</th>
          <td mat-cell *matCellDef="let row" (click)="abrirDetalle(row)" style="cursor: pointer;">
            {{ row.total_a_pagar - row.pagado | currency:'COP':'symbol' }}
          </td>
        </ng-container>

        <!-- Filas -->
        <tr mat-header-row *matHeaderRowDef="columnas"></tr>
        <tr mat-row *matRowDef="let row; columns: columnas;"></tr>
      </table>

      <!-- Paginador -->
      <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
    </div>

    <!-- RESUMEN -->
    <div class="resumen">
      <p><strong>Total general:</strong> {{ totalGeneral | currency:'COP':'symbol' }}</p>
      <p><strong>Total pagado:</strong> {{ totalPagado | currency:'COP':'symbol' }}</p>
      <p><strong>Total pendiente:</strong> {{ totalPendiente | currency:'COP':'symbol' }}</p>
    </div>

  </mat-card-content>
</mat-card>

<!-- DIALOG DETALLE -->
<ng-template #dialogDetalle let-data>
  <mat-dialog-content class="dialog-content">
    <h3 class="mb-3 text-center">ðŸ§¾ Detalle del Pago</h3>
    <div class="totales">
      <p><strong>Nombre:</strong> {{ data.nombre }}</p>
      <p><strong>CÃ©dula:</strong> {{ data.cedula }}</p>
      <p><strong>Fecha:</strong> {{ data.fecha }}</p>
      <p><strong>Estado:</strong> {{ data.estado }}</p>
      <p><strong>Total a pagar:</strong> {{ data.total_a_pagar | currency:'COP':'symbol' }}</p>
      <p><strong>Pagado:</strong> {{ data.pagado | currency:'COP':'symbol' }}</p>
      <p><strong>Pendiente:</strong> {{ data.total_a_pagar - data.pagado | currency:'COP':'symbol' }}</p>
    </div>
    <div class="text-center mt-3">
      <button mat-raised-button color="primary" mat-dialog-close>Cerrar</button>
    </div>
  </mat-dialog-content>
</ng-template>
